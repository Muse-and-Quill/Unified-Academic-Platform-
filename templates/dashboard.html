<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>UAP –DICT Dashboard</title>

<!-- GOOGLE FONTS -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    /* ============================================================
   DARK MODE FIXES — CHIP BUTTONS (Manage & Download buttons)
   ============================================================ */

body.theme-dark .btn-chip {
    background: rgba(255, 255, 255, 0.08);
    color: var(--text-main);
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 3px 12px rgba(0,0,0,0.45);
}

body.theme-dark .btn-chip:hover {
    background: rgba(255, 255, 255, 0.15);
    color: rgb(121, 208, 242);
    border-color: rgba(255, 255, 255, 0.28);
    transform: translateY(-2px);
}

</style>
</head>

<body class="theme-default">
  <!-- PRELOADER -->
  <div id="preloader">
    <img src="{{ url_for('static', filename='images/preloader.gif') }}" alt="Loading...">
  </div>

  <div class="bg-image"></div>
  <div class="bg-overlay"></div>

  <div class="page">
    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="nav-container">
        <a class="logo-link">
          <img src="{{ url_for('static', filename='images/uap-logo.png') }}" alt="UAP Logo" class="logo">
        </a>

        <a href="{{ url_for('auth_bp.dict_profile') }}" class="nav-avatar-link">
          <div class="nav-avatar">
            {% if emp and emp.profile_photo %}
              <img src="/{{ emp.profile_photo }}" alt="Profile">
            {% else %}
              <span>{{ (emp.name[0] if emp and emp.name else user_name[0]) }}</span>
            {% endif %}
          </div>
        </a>

        <div class="nav-right">
          <div class="nav-links">
            <a href="#overview">Overview</a>
            <a href="#bulk-upload">Bulk Upload</a>
            <a href="#summary">Summary</a>
            <a href="#downloads">Downloads</a>

            <!-- These are now pure links, not buttons -->
            <a href="{{ url_for('auth_bp.dict_contact_requests') }}" class="btn-chip">Contact Requests</a>
            <a href="{{ url_for('auth_bp.dict_profile') }}" class="btn-chip">My Profile</a>

            <a href="{{ url_for('auth_bp.logout') }}">
              <button class="btn-primary" type="button">Logout</button>
            </a>
          </div>

          <!-- Theme selector -->
           
<select id="themeSelectDesktop" class="theme-select" aria-label="Select theme">

            <option value="default">Default</option>
            <option value="rose">Rose</option>
            <option value="tulip">Tulip</option>
            <option value="beach">Beach</option>
            <option value="golden">Golden</option>
            <option value="dark">Dark Mode</option>
          </select>

          <button class="menu-btn" id="menuBtn" aria-label="Toggle navigation">☰</button>
        </div>
      </div>

      <!-- MOBILE MENU -->
      <div class="mobile-menu" id="mobileMenu">
        <a href="#overview">Overview</a>
        <a href="#bulk-upload">Upload</a>
        <a href="#summary">Summary</a>
        <a href="#downloads">Downloads</a>
<select id="themeSelectMobile" class="theme-select" aria-label="Select theme">

            <option value="default">Default</option>
            <option value="rose">Rose</option>
            <option value="tulip">Tulip</option>
            <option value="beach">Beach</option>
            <option value="golden">Golden</option>
            <option value="dark">Dark Mode</option>
          </select>
        <a href="{{ url_for('auth_bp.dict_contact_requests') }}">Contact Requests</a>
        <a href="{{ url_for('auth_bp.dict_profile') }}">My Profile</a>
        <a href="{{ url_for('auth_bp.logout') }}">
          <button class="btn-primary" type="button">Logout</button>
        </a>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="content">
      <!-- ========== SECTION 1: OVERVIEW ========== -->
      <section id="overview">
        <div class="section-header">
          <h2 class="section-title">DICT Dashboard</h2>
          <p class="section-subtitle">Overview of onboarding and academic identities.</p>
        </div>

        <div class="overview-top card card-hover reveal-card">
          <div class="overview-main">
            <div class="welcome-title">Welcome, {{ emp.name if emp else user_name }}</div>
            <div class="welcome-sub">
              Employee ID: <strong>{{ employee_id }}</strong><br/>
              You are in the Help &amp; Support (DICT) Dashboard.
            </div>
            <span class="pill">HSD • Bulk Onboarding • Secure Credentials</span>

            <div class="quick-actions">
              <a href="{{ url_for('auth_bp.dict_students') }}" class="btn-chip">Manage Students</a>
              <a href="{{ url_for('auth_bp.dict_teachers') }}" class="btn-chip">Manage Teachers</a>
              <a href="{{ url_for('auth_bp.dict_staff') }}" class="btn-chip">Manage Employees</a>
            </div>
          </div>

          <div class="overview-side">
            <div class="stats-row">
              <div class="stat-card card-hover reveal-card">
                <div class="stat-label">Total Students</div>
                <div class="stat-value">{{ student_count }}</div>
              </div>
              <div class="stat-card card-hover reveal-card">
                <div class="stat-label">Total Teachers</div>
                <div class="stat-value">{{ teacher_count }}</div>
              </div>
              <div class="stat-card card-hover reveal-card">
                <div class="stat-label">Total Staffs</div>
                <div class="stat-value">{{ staff_count }}</div>
              </div>
            </div>
            <p class="info-note">
              Tip: Use Bulk Upload to keep data clean and consistent across all identities.
            </p>
          </div>
        </div>
      </section>

      <!-- ========== SECTION 2: BULK UPLOAD ========== -->
      <section id="bulk-upload">
        <div class="section-header">
          <h2 class="section-title">Bulk Upload</h2>
          <p class="section-subtitle">Upload CSV / Excel and auto-generate IDs, rolls, and credentials.</p>
        </div>

        <div class="card card-hover reveal-card">
          <!-- FLASH MESSAGES -->
          <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="flash-item {{ category }} card-hover reveal-card">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}
          </div>

          <div class="bulk-grid">
            <!-- STUDENT UPLOAD CARD -->
            <div class="upload-card">
              <h3>Upload Students</h3>
              <p>Generate Registration No, Department-wise Roll No, and email credentials.</p>

              <form method="POST"
                    action="{{ url_for('auth_bp.upload_students') }}"
                    enctype="multipart/form-data">
                <div>
                  <label for="student_department">Department</label>
                  <input type="text" id="student_department" name="student_department"
                         placeholder="e.g. CSE" required />
                </div>

                <div>
                  <label for="student_category">Category (optional)</label>
                  <input type="text" id="student_category" name="student_category"
                         placeholder="Regular / Scholarship" />
                </div>

                <div>
                  <label for="student_label">Label (optional)</label>
                  <input type="text" id="student_label" name="student_label"
                         placeholder="Hostel / Day Scholar" />
                </div>

                <div>
                  <label for="student_session_start_year">Session Start Year</label>
                  <input type="number" id="student_session_start_year"
                         name="student_session_start_year"
                         placeholder="2025" required />
                </div>

                <div>
                  <label for="student_session_end_year">Session End Year</label>
                  <input type="number" id="student_session_end_year"
                         name="student_session_end_year"
                         placeholder="2029" required />
                </div>

                <div>
                  <label for="student_file">Student File (CSV / Excel)</label>
                  <input type="file" id="student_file" name="student_file"
                         accept=".csv,.xlsx,.xls" required />
                </div>

                <div class="helper-text">
                  Expected columns: <strong>name</strong>, <strong>email</strong>, (optional) <strong>phone</strong>.<br/>
                  Password format: <code>Welcome@&lt;RegistrationNumber&gt;</code>.
                </div>

                <button type="submit" class="btn-upload">Upload Students</button>
              </form>
            </div>

            <!-- TEACHER UPLOAD CARD -->
            <div class="upload-card">
              <h3>Upload Teachers</h3>
              <p>Create teacher IDs and share login details via email.</p>

              <form method="POST"
                    action="{{ url_for('auth_bp.upload_teachers') }}"
                    enctype="multipart/form-data">
                <div>
                  <label for="teacher_department">Department</label>
                  <input type="text" id="teacher_department" name="teacher_department"
                         placeholder="CSE / LAW / COMMERCE & MANAGEMENT" required />
                </div>

                <div>
                  <label for="teacher_session_start_year">Session Start Year</label>
                  <input type="number" id="teacher_session_start_year"
                         name="teacher_session_start_year"
                         placeholder="2025" required />
                </div>

                <div>
                  <label for="teacher_session_end_year">Session End Year</label>
                  <input type="number" id="teacher_session_end_year"
                         name="teacher_session_end_year"
                         placeholder="2029" required />
                </div>

                <div>
                  <label for="teacher_file">Teacher File (CSV / Excel)</label>
                  <input type="file" id="teacher_file" name="teacher_file"
                         accept=".csv,.xlsx,.xls" required />
                </div>

                <div class="helper-text">
                  Expected columns: <strong>name</strong>, <strong>email</strong>, (optional) <strong>phone</strong>, (optional) <strong>designation</strong>.<br/>
                  Password format: <code>Welcome@&lt;RegistrationNumber&gt;</code>.
                </div>

                <button type="submit" class="btn-upload">Upload Teachers</button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- ========== SECTION 3: SUMMARY & REPORTS ========== -->
      <section id="summary">
        <div class="section-header">
          <h2 class="section-title">Summary &amp; Reports</h2>
          <p class="section-subtitle">Quick glance at distribution by department and roles.</p>
        </div>

        <div class="summary-grid">
          <!-- Students summary -->
          <div class="card summary-card card-hover reveal-card">
            <h3>Students by Department</h3>
            <table>
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                {% for d in student_dept_summary %}
                <tr>
                  <td>{{ d._id or 'Unknown' }}</td>
                  <td>{{ d.count }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Teachers summary -->
          <div class="card summary-card card-hover reveal-card">
            <h3>Teachers by Department</h3>
            <table>
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                {% for d in teacher_dept_summary %}
                <tr>
                  <td>{{ d._id or 'Unknown' }}</td>
                  <td>{{ d.count }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Staff summary -->
          <div class="card summary-card card-hover reveal-card">
            <h3>Employees by Role</h3>
            <table>
              <thead>
                <tr>
                  <th>Role</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                {% for r in staff_role_summary %}
                <tr>
                  <td>{{ r._id or 'Unknown' }}</td>
                  <td>{{ r.count }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ========== SECTION 4: DOWNLOADS ========== -->
      <section id="downloads">
        <div class="section-header">
          <h2 class="section-title">Downloads</h2>
          <p class="section-subtitle">Export current records for backup or offline processing.</p>
        </div>

        <div class="card card-hover reveal-card">
          <div class="download-row">
            <a href="{{ url_for('auth_bp.export_students_csv') }}" class="btn-chip">
              Download Students CSV
            </a>

            <a href="{{ url_for('auth_bp.export_teachers_csv') }}" class="btn-chip">
              Download Teachers CSV
            </a>

            <a href="{{ url_for('auth_bp.export_staff_csv') }}" class="btn-chip">
              Download Staff CSV
            </a>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ================= JS ================= -->
  <script>
    // Theme handling
const THEME_KEY = "uap-theme";
const themes = ["default", "rose", "tulip", "beach", "golden", "dark"];

const themeSelectDesktop = document.getElementById("themeSelectDesktop");
const themeSelectMobile  = document.getElementById("themeSelectMobile");

function applyTheme(theme) {
  if (!themes.includes(theme)) theme = "default";

  // remove previous theme classes
  document.body.classList.remove(...themes.map(t => "theme-" + t));
  // add new theme class
  document.body.classList.add("theme-" + theme);

  // remember choice
  localStorage.setItem(THEME_KEY, theme);

  // keep both dropdowns in sync
  if (themeSelectDesktop) themeSelectDesktop.value = theme;
  if (themeSelectMobile)  themeSelectMobile.value  = theme;
}

// initial load
const savedTheme = localStorage.getItem(THEME_KEY) || "default";
applyTheme(savedTheme);

// desktop selector listener
if (themeSelectDesktop) {
  themeSelectDesktop.addEventListener("change", (e) => {
    applyTheme(e.target.value);
  });
}

// mobile selector listener
if (themeSelectMobile) {
  themeSelectMobile.addEventListener("change", (e) => {
    applyTheme(e.target.value);
  });
}

    // Preloader
    window.addEventListener("load", () => {
      setTimeout(() => {
        const pre = document.getElementById("preloader");
        if (pre) pre.style.display = "none";
      }, 1500);
    });

    // Mobile menu with outside-click close
    const menuBtn = document.getElementById("menuBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    let menuOpen = false;

    function setMenu(open) {
      menuOpen = open;
      if (menuBtn) menuBtn.textContent = open ? "✖" : "☰";
      if (mobileMenu) mobileMenu.style.display = open ? "flex" : "none";
    }

    if (menuBtn && mobileMenu) {
      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        setMenu(!menuOpen);
      });
    }

    // Close mobile menu on link/button click inside menu
    if (mobileMenu) {
      mobileMenu.addEventListener("click", (e) => {
        if (e.target.tagName === "A" || e.target.tagName === "BUTTON") {
          setMenu(false);
        }
      });
    }

    // Close mobile menu when clicking anywhere outside
    document.addEventListener("click", (e) => {
      if (!menuOpen) return;
      if (mobileMenu && mobileMenu.contains(e.target)) return;
      if (menuBtn && e.target === menuBtn) return;
      setMenu(false);
    });

    // Handle BFCache back navigation
    window.addEventListener("pageshow", function (event) {
      if (event.persisted) {
        window.location.reload();
      }
    });

    // Scroll reveal for cards
    const animatedCards = document.querySelectorAll(".reveal-card");

    if ("IntersectionObserver" in window) {
      const observer = new IntersectionObserver(
        (entries, obs) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("visible");
              obs.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.12 }
      );

      animatedCards.forEach((card) => observer.observe(card));
    } else {
      animatedCards.forEach((card) => card.classList.add("visible"));
    }

    // === Active nav link on scroll ===
const sections = document.querySelectorAll("main section[id]");
const navLinksAll = document.querySelectorAll(
  '.nav-links a[href^="#"], .mobile-menu a[href^="#"]'
);

const sectionToLinks = {};
sections.forEach((section) => {
  const id = section.id;
  const links = document.querySelectorAll(`a[href="#${id}"]`);
  sectionToLinks[id] = links;
});

function clearActiveLinks() {
  navLinksAll.forEach((link) => link.classList.remove("active"));
}

if ("IntersectionObserver" in window) {
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          clearActiveLinks();
          (sectionToLinks[id] || []).forEach((link) =>
            link.classList.add("active")
          );
        }
      });
    },
    {
      root: null,
      threshold: 0.4, // 40% of section in view
    }
  );

  sections.forEach((section) => observer.observe(section));
} else {
  // Fallback for very old browsers – simple scroll handler
  window.addEventListener("scroll", () => {
    let currentId = null;
    sections.forEach((section) => {
      const rect = section.getBoundingClientRect();
      if (rect.top <= 120 && rect.bottom >= 120) {
        currentId = section.id;
      }
    });
    if (currentId) {
      clearActiveLinks();
      (sectionToLinks[currentId] || []).forEach((link) =>
        link.classList.add("active")
      );
    }
  });
}

  </script>
</body>
</html>
